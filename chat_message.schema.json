{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ChatMessage",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "session_id": {
      "type": "string",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
    },
    "message_id": {
      "type": "string",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
    },
    "timestamp": {
      "type": "string",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"
    },
    "user_role": {
      "type": "string",
      "enum": ["user", "bot", "admin", "system"]
    },
    "channel": {
      "type": "string",
      "enum": ["web", "mobile", "api", "slack", "teams"]
    },
    "raw_text": {
      "type": "string",
      "maxLength": 4000
    },
    "clean_text": {
      "type": "string",
      "maxLength": 4000
    },
    "language": {
      "type": "string",
      "pattern": "^[a-z]{2}$"
    },
    "phi_flags": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": ["NAME", "PHONE", "EMAIL", "DATE", "ID", "IP", "ADDRESS", "SSN", "MEDICAL_RECORD", "OTHER"]
      },
      "uniqueItems": true
    },
    "audit_trail": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "event_id": {
            "type": "string",
            "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
          },
          "actor": {
            "type": "string",
            "maxLength": 256
          },
          "action": {
            "type": "string",
            "enum": ["ingest", "redact", "access", "delete", "export", "annotate"]
          },
          "timestamp": {
            "type": "string",
            "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"
          },
          "reason": {
            "type": "string",
            "maxLength": 1000
          },
          "details": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "required": ["event_id", "actor", "action", "timestamp"]
      }
    },
    "intent": {
      "type": "string",
      "maxLength": 100
    },
    "entities": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "maxLength": 50
          },
          "value": {
            "type": "string",
            "maxLength": 1000
          },
          "confidence": {
            "type": "number",
            "minimum": 0.0,
            "maximum": 1.0
          }
        },
        "required": ["type", "value"]
      }
    },
    "urgency": {
      "type": "string",
      "enum": ["low", "medium", "high", "critical"]
    },
    "confidence": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0
    },
    "consent_given": {
      "type": "boolean"
    },
    "retention_policy": {
      "type": "string",
      "maxLength": 64
    }
  },
  "required": [
    "session_id",
    "message_id",
    "timestamp",
    "user_role",
    "channel",
    "raw_text",
    "clean_text",
    "language",
    "phi_flags",
    "audit_trail"
  ]
}
